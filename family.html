<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Growth Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .login-box input {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #667eea;
            border-radius: 10px;
            width: 250px;
            text-align: center;
            margin-bottom: 20px;
        }

        .login-box button {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-box button:hover {
            transform: scale(1.05);
        }

        .main-app {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
        }

        .language-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .language-toggle button {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .language-toggle button.active {
            background: #667eea;
            color: white;
        }

        .child-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .child-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border: 3px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            position: relative;
        }

        .child-btn.philip { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .child-btn.agnes { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .child-btn.edmund { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .child-btn.leo { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .child-btn.zoe { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }

        .child-btn.active {
            border-color: #ffd700;
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255,215,0,0.5);
        }

        .child-btn .level-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ffd700;
            color: #333;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .tracking-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .tracking-container {
                grid-template-columns: 1fr;
            }
        }

        .behavior-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .behavior-panel.positive {
            border-top: 5px solid #43e97b;
        }

        .behavior-panel.negative {
            border-top: 5px solid #f5576c;
        }

        .behavior-panel h2 {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .behavior-panel h2 .count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .behavior-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .behavior-item {
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .behavior-item .frequency {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .behavior-item.positive-item {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .behavior-item.positive-item:hover {
            background: #43e97b;
            color: white;
            transform: scale(1.05);
        }

        .behavior-item.negative-item {
            background: #ffebee;
            color: #c62828;
        }

        .behavior-item.negative-item:hover {
            background: #f5576c;
            color: white;
            transform: scale(1.05);
        }

        .add-behavior {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-behavior input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }

        .add-behavior button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .today-log {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .today-log h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .log-entries {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-entry.positive {
            background: #e8f5e9;
            border-left: 4px solid #43e97b;
        }

        .log-entry.negative {
            background: #ffebee;
            border-left: 4px solid #f5576c;
        }

        .log-entry .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .rewards-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .rewards-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .reward-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .reward-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }

        .reward-input button {
            padding: 10px 20px;
            background: #43e97b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .reward-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .reward-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comments-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .comments-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .comments-section textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
        }

        .progress-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .progress-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .level-display {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .level-display h3 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .xp-bar {
            background: rgba(0,0,0,0.2);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .historical-data {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .historical-data h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .date-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .date-selector button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .date-selector input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }

        .chart-container {
            margin-top: 20px;
            height: 300px;
        }

        .motivational-message {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #43e97b;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1>üåü Family Growth Tracker</h1>
            <p style="margin-bottom: 20px; color: #666;">Enter password to access</p>
            <input type="password" id="passwordInput" placeholder="Password" />
            <br>
            <button onclick="login()">Enter</button>
        </div>
    </div>

    <!-- Save Indicator -->
    <div id="saveIndicator" class="save-indicator">‚úì Saved</div>

    <!-- Main App -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <div class="header">
            <h1>üåü <span data-lang="title">Family Growth Tracker</span></h1>
            <div class="language-toggle">
                <span><span data-lang="language">Language</span>:</span>
                <button id="langEN" class="active" onclick="setLanguage('en')">English</button>
                <button id="langDE" onclick="setLanguage('de')">Deutsch</button>
            </div>
        </div>

        <!-- Child Selector -->
        <div class="child-selector">
            <button class="child-btn philip" onclick="selectChild('philip')">
                Philip
                <div class="level-badge" id="level-philip">1</div>
            </button>
            <button class="child-btn agnes" onclick="selectChild('agnes')">
                Agnes
                <div class="level-badge" id="level-agnes">1</div>
            </button>
            <button class="child-btn edmund" onclick="selectChild('edmund')">
                Edmund
                <div class="level-badge" id="level-edmund">1</div>
            </button>
            <button class="child-btn leo" onclick="selectChild('leo')">
                Leo
                <div class="level-badge" id="level-leo">1</div>
            </button>
            <button class="child-btn zoe" onclick="selectChild('zoe')">
                Zo√´
                <div class="level-badge" id="level-zoe">1</div>
            </button>
        </div>

        <!-- Motivational Message -->
        <div class="motivational-message" id="motivationalMessage">
            <span data-lang="welcome">Every choice is a chance to grow! üå±</span>
        </div>

        <!-- Level Display -->
        <div class="level-display">
            <h3><span data-lang="level">Level</span> <span id="currentLevel">1</span></h3>
            <p><span data-lang="xpToNext">XP to next level</span>: <span id="currentXP">0</span>/<span id="xpNeeded">10</span></p>
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill" style="width: 0%;">
                    <span id="xpPercent">0%</span>
                </div>
            </div>
        </div>

        <!-- Tracking Container -->
        <div class="tracking-container">
            <!-- Positive Behaviors -->
            <div class="behavior-panel positive">
                <h2>
                    <span>‚ú® <span data-lang="positiveChoices">Positive Choices</span></span>
                    <span class="count" id="positiveCount">0</span>
                </h2>
                <div class="behavior-list" id="positiveBehaviors"></div>
                <div class="add-behavior">
                    <input type="text" id="newPositive" placeholder="Add new positive behavior..." data-lang-placeholder="addPositive" />
                    <button onclick="addCustomBehavior('positive')">+</button>
                </div>
            </div>

            <!-- Negative Behaviors -->
            <div class="behavior-panel negative">
                <h2>
                    <span>‚ö†Ô∏è <span data-lang="challengingChoices">Challenging Choices</span></span>
                    <span class="count" id="negativeCount">0</span>
                </h2>
                <div class="behavior-list" id="negativeBehaviors"></div>
                <div class="add-behavior">
                    <input type="text" id="newNegative" placeholder="Add new challenging behavior..." data-lang-placeholder="addNegative" />
                    <button onclick="addCustomBehavior('negative')">+</button>
                </div>
            </div>
        </div>

        <!-- Today's Log -->
        <div class="today-log">
            <h2>üìù <span data-lang="todayLog">Today's Choices</span></h2>
            <div class="log-entries" id="logEntries"></div>
        </div>

        <!-- Rewards/Consequences -->
        <div class="rewards-section">
            <h2>üéÅ <span data-lang="rewardsConsequences">Rewards & Consequences</span></h2>
            <div class="reward-input">
                <input type="text" id="newReward" placeholder="Add reward or consequence..." data-lang-placeholder="addReward" />
                <button onclick="addReward()"><span data-lang="add">Add</span></button>
            </div>
            <div class="reward-list" id="rewardList"></div>
        </div>

        <!-- Comments -->
        <div class="comments-section">
            <h2>üí≠ <span data-lang="dailyNotes">Daily Notes</span></h2>
            <textarea id="dailyComments" placeholder="Notes about today..." data-lang-placeholder="notesPlaceholder" oninput="saveComments()"></textarea>
        </div>

        <!-- Progress Charts -->
        <div class="progress-section">
            <h2>üìä <span data-lang="progressCharts">Progress Over Time</span></h2>
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>
        </div>

        <!-- Historical Data -->
        <div class="historical-data">
            <h2>üìÖ <span data-lang="historicalData">Historical Data</span></h2>
            <div class="date-selector">
                <button onclick="changeDate(-1)">‚Üê <span data-lang="previous">Previous</span></button>
                <input type="date" id="dateSelector" onchange="loadHistoricalData()" />
                <button onclick="changeDate(1)"><span data-lang="next">Next</span> ‚Üí</button>
                <button onclick="loadToday()"><span data-lang="today">Today</span></button>
            </div>
            <div id="historicalContent"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Pre-configured for your project
        const firebaseConfig = {
            apiKey: "AIzaSyDqgDmGozI6p0Tcbq3UHxqoDwzcQkC5Td8",
            authDomain: "family-b24ae.firebaseapp.com",
            databaseURL: "https://family-b24ae-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "family-b24ae",
            storageBucket: "family-b24ae.firebasestorage.app",
            messagingSenderId: "189362354313",
            appId: "1:189362354313:web:769e9fe823e5a6afe6ae58"
        };

        // Initialize Firebase automatically
        let database = null;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            console.log('Falling back to local storage only');
        }

        // Language translations
        const translations = {
            en: {
                title: "Family Growth Tracker",
                language: "Language",
                welcome: "Every choice is a chance to grow! üå±",
                positiveChoices: "Positive Choices",
                challengingChoices: "Challenging Choices",
                todayLog: "Today's Choices",
                rewardsConsequences: "Rewards & Consequences",
                dailyNotes: "Daily Notes",
                progressCharts: "Progress Over Time",
                historicalData: "Historical Data",
                level: "Level",
                xpToNext: "XP to next level",
                add: "Add",
                previous: "Previous",
                next: "Next",
                today: "Today",
                addPositive: "Add new positive behavior...",
                addNegative: "Add new challenging behavior...",
                addReward: "Add reward or consequence...",
                notesPlaceholder: "Notes about today...",
                motivationalMessages: [
                    "Every choice is a chance to grow! üå±",
                    "You're making great progress! Keep it up! ‚≠ê",
                    "Small steps lead to big changes! üöÄ",
                    "Your choices shape your future! üåü",
                    "Learning and growing every day! üåà",
                    "Be proud of your positive choices! üí™",
                    "Every day is a fresh start! ‚òÄÔ∏è"
                ]
            },
            de: {
                title: "Familien-Wachstums-Tracker",
                language: "Sprache",
                welcome: "Jede Wahl ist eine Chance zu wachsen! üå±",
                positiveChoices: "Positive Entscheidungen",
                challengingChoices: "Herausfordernde Entscheidungen",
                todayLog: "Heutige Entscheidungen",
                rewardsConsequences: "Belohnungen & Konsequenzen",
                dailyNotes: "Tagesnotizen",
                progressCharts: "Fortschritt im Laufe der Zeit",
                historicalData: "Historische Daten",
                level: "Level",
                xpToNext: "XP bis zum n√§chsten Level",
                add: "Hinzuf√ºgen",
                previous: "Vorherige",
                next: "N√§chste",
                today: "Heute",
                addPositive: "Neues positives Verhalten hinzuf√ºgen...",
                addNegative: "Neues herausforderndes Verhalten hinzuf√ºgen...",
                addReward: "Belohnung oder Konsequenz hinzuf√ºgen...",
                notesPlaceholder: "Notizen √ºber heute...",
                motivationalMessages: [
                    "Jede Wahl ist eine Chance zu wachsen! üå±",
                    "Du machst tolle Fortschritte! Weiter so! ‚≠ê",
                    "Kleine Schritte f√ºhren zu gro√üen Ver√§nderungen! üöÄ",
                    "Deine Entscheidungen formen deine Zukunft! üåü",
                    "Jeden Tag lernen und wachsen! üåà",
                    "Sei stolz auf deine positiven Entscheidungen! üí™",
                    "Jeder Tag ist ein Neuanfang! ‚òÄÔ∏è"
                ]
            }
        };

        // Default behaviors
        const defaultBehaviors = {
            positive: {
                en: [
                    "Helped with chores", "Did homework without being asked", "Shared with sibling",
                    "Used kind words", "Followed instructions", "Helped someone",
                    "Showed patience", "Cleaned room", "Practiced instrument",
                    "Read a book", "Exercised", "Ate healthy food",
                    "Showed empathy", "Solved problem peacefully", "Tried something new",
                    "Was respectful", "Brushed teeth without reminder", "Wore retainer",
                    "Completed assignment", "Showed gratitude", "Made good decision"
                ],
                de: [
                    "Bei Hausarbeit geholfen", "Hausaufgaben ohne Aufforderung gemacht", "Mit Geschwistern geteilt",
                    "Freundliche Worte benutzt", "Anweisungen befolgt", "Jemandem geholfen",
                    "Geduld gezeigt", "Zimmer aufger√§umt", "Instrument ge√ºbt",
                    "Buch gelesen", "Sport gemacht", "Gesund gegessen",
                    "Empathie gezeigt", "Problem friedlich gel√∂st", "Etwas Neues probiert",
                    "Respektvoll gewesen", "Z√§hne ohne Erinnerung geputzt", "Retainer getragen",
                    "Aufgabe erledigt", "Dankbarkeit gezeigt", "Gute Entscheidung getroffen"
                ]
            },
            negative: {
                en: [
                    "Flipped someone off", "Fighting with sibling", "Property damage",
                    "Temper tantrum", "Screaming", "Threatened to run away",
                    "Verbal threat", "Stealing", "Refused to do chores",
                    "Not wearing retainer", "Not doing homework", "Lying",
                    "Disrespectful language", "Hitting/kicking", "Breaking rules",
                    "Ignoring instructions", "Throwing things", "Slamming doors",
                    "Name calling", "Interrupting constantly", "Refusing to cooperate",
                    "Back talking", "Leaving without permission", "Damaging belongings"
                ],
                de: [
                    "Stinkefinger gezeigt", "Mit Geschwistern gestritten", "Sachbesch√§digung",
                    "Wutanfall", "Geschrien", "Gedroht wegzulaufen",
                    "Verbale Drohung", "Stehlen", "Hausarbeit verweigert",
                    "Retainer nicht getragen", "Hausaufgaben nicht gemacht", "Gelogen",
                    "Respektlose Sprache", "Schlagen/Treten", "Regeln gebrochen",
                    "Anweisungen ignoriert", "Dinge geworfen", "T√ºren zugeknallt",
                    "Beschimpfungen", "St√§ndig unterbrochen", "Zusammenarbeit verweigert",
                    "Widersprochen", "Ohne Erlaubnis weggegangen", "Sachen besch√§digt"
                ]
            }
        };

        // Global state
        let currentLanguage = 'en';
        let currentChild = 'philip';
        let currentDate = new Date().toISOString().split('T')[0];
        let chart = null;
        let appData = {
            children: {
                philip: { xp: 0, level: 1, behaviors: {}, logs: {}, rewards: [], comments: {} },
                agnes: { xp: 0, level: 1, behaviors: {}, logs: {}, rewards: [], comments: {} },
                edmund: { xp: 0, level: 1, behaviors: {}, logs: {}, rewards: [], comments: {} },
                leo: { xp: 0, level: 1, behaviors: {}, logs: {}, rewards: [], comments: {} },
                zoe: { xp: 0, level: 1, behaviors: {}, logs: {}, rewards: [], comments: {} }
            },
            customBehaviors: {
                positive: { en: [], de: [] },
                negative: { en: [], de: [] }
            }
        };

        // Initialize
        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === '443322') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadData();
                if (database) {
                    loadDataFromFirebase();
                }
                initializeApp();
            } else {
                alert('Incorrect password');
            }
        }

        function initializeApp() {
            document.getElementById('dateSelector').value = currentDate;
            selectChild('philip');
            updateMotivationalMessage();
            setInterval(updateMotivationalMessage, 30000); // Change message every 30 seconds
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            document.getElementById('langDE').classList.toggle('active', lang === 'de');
            
            // Update all translatable elements
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            renderBehaviors();
        }

        function selectChild(childId) {
            currentChild = childId;
            document.querySelectorAll('.child-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.child-btn.${childId}`).classList.add('active');
            renderChildData();
        }

        function renderChildData() {
            renderBehaviors();
            updateCounts();
            updateLevelDisplay();
            updateTodayLog();
            updateRewardsList();
            loadComments();
            updateChart();
        }

        function renderBehaviors() {
            const child = appData.children[currentChild];
            const positiveBehaviors = [...defaultBehaviors.positive[currentLanguage], ...appData.customBehaviors.positive[currentLanguage]];
            const negativeBehaviors = [...defaultBehaviors.negative[currentLanguage], ...appData.customBehaviors.negative[currentLanguage]];

            // Sort by frequency
            const sortedPositive = positiveBehaviors.sort((a, b) => {
                const freqA = child.behaviors[a] || 0;
                const freqB = child.behaviors[b] || 0;
                return freqB - freqA;
            });

            const sortedNegative = negativeBehaviors.sort((a, b) => {
                const freqA = child.behaviors[a] || 0;
                const freqB = child.behaviors[b] || 0;
                return freqB - freqA;
            });

            // Render positive behaviors
            const positiveContainer = document.getElementById('positiveBehaviors');
            positiveContainer.innerHTML = sortedPositive.map(behavior => {
                const frequency = child.behaviors[behavior] || 0;
                return `<div class="behavior-item positive-item" onclick="logBehavior('${behavior}', 'positive')">
                    ${behavior} ${frequency > 0 ? `<span class="frequency">${frequency}</span>` : ''}
                </div>`;
            }).join('');

            // Render negative behaviors
            const negativeContainer = document.getElementById('negativeBehaviors');
            negativeContainer.innerHTML = sortedNegative.map(behavior => {
                const frequency = child.behaviors[behavior] || 0;
                return `<div class="behavior-item negative-item" onclick="logBehavior('${behavior}', 'negative')">
                    ${behavior} ${frequency > 0 ? `<span class="frequency">${frequency}</span>` : ''}
                </div>`;
            }).join('');
        }

        function logBehavior(behavior, type) {
            const child = appData.children[currentChild];
            
            // Increment frequency
            if (!child.behaviors[behavior]) {
                child.behaviors[behavior] = 0;
            }
            child.behaviors[behavior]++;

            // Add to today's log
            if (!child.logs[currentDate]) {
                child.logs[currentDate] = [];
            }
            
            const timestamp = new Date().toLocaleTimeString();
            child.logs[currentDate].push({
                behavior: behavior,
                type: type,
                timestamp: timestamp
            });

            // Update XP for positive behaviors
            if (type === 'positive') {
                child.xp += 1;
                checkLevelUp();
            }

            saveData();
            renderChildData();
        }

        function checkLevelUp() {
            const child = appData.children[currentChild];
            const xpNeeded = child.level * 10;
            
            if (child.xp >= xpNeeded) {
                child.xp -= xpNeeded;
                child.level++;
                showLevelUpMessage();
                updateLevelBadges();
            }
        }

        function showLevelUpMessage() {
            const child = appData.children[currentChild];
            alert(`üéâ ${currentChild.charAt(0).toUpperCase() + currentChild.slice(1)} leveled up to Level ${child.level}! Keep up the great choices!`);
        }

        function updateLevelDisplay() {
            const child = appData.children[currentChild];
            const xpNeeded = child.level * 10;
            const percentage = (child.xp / xpNeeded * 100).toFixed(0);

            document.getElementById('currentLevel').textContent = child.level;
            document.getElementById('currentXP').textContent = child.xp;
            document.getElementById('xpNeeded').textContent = xpNeeded;
            document.getElementById('xpFill').style.width = percentage + '%';
            document.getElementById('xpPercent').textContent = percentage + '%';
        }

        function updateLevelBadges() {
            Object.keys(appData.children).forEach(childId => {
                const level = appData.children[childId].level;
                document.getElementById(`level-${childId}`).textContent = level;
            });
        }

        function updateCounts() {
            const child = appData.children[currentChild];
            const todayLog = child.logs[currentDate] || [];
            
            const positiveCount = todayLog.filter(entry => entry.type === 'positive').length;
            const negativeCount = todayLog.filter(entry => entry.type === 'negative').length;

            document.getElementById('positiveCount').textContent = positiveCount;
            document.getElementById('negativeCount').textContent = negativeCount;
        }

        function updateTodayLog() {
            const child = appData.children[currentChild];
            const todayLog = child.logs[currentDate] || [];
            
            const logContainer = document.getElementById('logEntries');
            if (todayLog.length === 0) {
                logContainer.innerHTML = '<p style="color: #999; text-align: center;">No entries yet today</p>';
                return;
            }

            logContainer.innerHTML = todayLog.map((entry, index) => {
                return `<div class="log-entry ${entry.type}">
                    <span>${entry.timestamp} - ${entry.behavior}</span>
                    <button class="delete-btn" onclick="deleteLogEntry(${index})">√ó</button>
                </div>`;
            }).reverse().join('');
        }

        function deleteLogEntry(index) {
            const child = appData.children[currentChild];
            const todayLog = child.logs[currentDate];
            const actualIndex = todayLog.length - 1 - index; // Because display is reversed
            
            const entry = todayLog[actualIndex];
            
            // Decrease frequency
            if (child.behaviors[entry.behavior] > 0) {
                child.behaviors[entry.behavior]--;
            }

            // Remove XP if it was positive
            if (entry.type === 'positive' && child.xp > 0) {
                child.xp--;
            }

            todayLog.splice(actualIndex, 1);
            saveData();
            renderChildData();
        }

        function addCustomBehavior(type) {
            const inputId = type === 'positive' ? 'newPositive' : 'newNegative';
            const input = document.getElementById(inputId);
            const behavior = input.value.trim();

            if (!behavior) return;

            // Add to both languages initially with same text
            appData.customBehaviors[type].en.push(behavior);
            appData.customBehaviors[type].de.push(behavior);

            input.value = '';
            saveData();
            renderBehaviors();
        }

        function addReward() {
            const input = document.getElementById('newReward');
            const reward = input.value.trim();

            if (!reward) return;

            const child = appData.children[currentChild];
            if (!child.rewards) child.rewards = [];
            
            child.rewards.push({
                text: reward,
                date: currentDate,
                timestamp: new Date().toISOString()
            });

            input.value = '';
            saveData();
            updateRewardsList();
        }

        function updateRewardsList() {
            const child = appData.children[currentChild];
            const rewards = child.rewards || [];
            
            const container = document.getElementById('rewardList');
            if (rewards.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No rewards or consequences recorded</p>';
                return;
            }

            container.innerHTML = rewards.slice().reverse().map((reward, index) => {
                return `<div class="reward-item">
                    <span>${reward.text} <small>(${reward.date})</small></span>
                    <button class="delete-btn" onclick="deleteReward(${rewards.length - 1 - index})">√ó</button>
                </div>`;
            }).join('');
        }

        function deleteReward(index) {
            const child = appData.children[currentChild];
            child.rewards.splice(index, 1);
            saveData();
            updateRewardsList();
        }

        function saveComments() {
            const child = appData.children[currentChild];
            const comments = document.getElementById('dailyComments').value;
            
            if (!child.comments) child.comments = {};
            child.comments[currentDate] = comments;
            
            saveData();
            showSaveIndicator();
        }

        function loadComments() {
            const child = appData.children[currentChild];
            const comments = child.comments ? child.comments[currentDate] || '' : '';
            document.getElementById('dailyComments').value = comments;
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function updateChart() {
            const child = appData.children[currentChild];
            const logs = child.logs || {};
            
            // Get last 14 days of data
            const dates = [];
            const positiveData = [];
            const negativeData = [];
            
            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayLog = logs[dateStr] || [];
                
                dates.push(date.toLocaleDateString());
                positiveData.push(dayLog.filter(e => e.type === 'positive').length);
                negativeData.push(dayLog.filter(e => e.type === 'negative').length);
            }

            if (chart) {
                chart.destroy();
            }

            const ctx = document.getElementById('progressChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: translations[currentLanguage].positiveChoices,
                            data: positiveData,
                            borderColor: '#43e97b',
                            backgroundColor: 'rgba(67, 233, 123, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: translations[currentLanguage].challengingChoices,
                            data: negativeData,
                            borderColor: '#f5576c',
                            backgroundColor: 'rgba(245, 87, 108, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function changeDate(days) {
            const date = new Date(document.getElementById('dateSelector').value);
            date.setDate(date.getDate() + days);
            document.getElementById('dateSelector').value = date.toISOString().split('T')[0];
            loadHistoricalData();
        }

        function loadToday() {
            document.getElementById('dateSelector').value = new Date().toISOString().split('T')[0];
            currentDate = new Date().toISOString().split('T')[0];
            renderChildData();
        }

        function loadHistoricalData() {
            const selectedDate = document.getElementById('dateSelector').value;
            currentDate = selectedDate;
            renderChildData();
        }

        function updateMotivationalMessage() {
            const messages = translations[currentLanguage].motivationalMessages;
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('motivationalMessage').textContent = randomMessage;
        }

        function saveData() {
            // Save to local storage
            localStorage.setItem('behaviorTrackerData', JSON.stringify(appData));
            
            // Save to Firebase if configured
            if (database) {
                database.ref('behaviorTracker').set(appData);
            }

            showSaveIndicator();
        }

        function loadData() {
            // Try to load from local storage
            const savedData = localStorage.getItem('behaviorTrackerData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                    updateLevelBadges();
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function loadDataFromFirebase() {
            if (!database) return;
            
            database.ref('behaviorTracker').once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appData = data;
                    updateLevelBadges();
                    renderChildData();
                    console.log('Data loaded from Firebase');
                }
            });

            // Set up real-time sync
            database.ref('behaviorTracker').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appData = data;
                    updateLevelBadges();
                    renderChildData();
                }
            });
        }

        // Initialize level badges on load
        window.onload = () => {
            updateLevelBadges();
        };
    </script>
</body>
</html>